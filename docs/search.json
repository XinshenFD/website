[
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "Risk Stratification and IOL Power Calculation Tool for Marfan Syndrome Patients with Ectopia Lentis",
    "section": "",
    "text": "#| '!! shinylive warning !!': |\n#|   shinylive does not work in self-contained HTML documents.\n#|   Please set `embed-resources: false` in your metadata.\n#| standalone: true\nlibrary(bslib)\nlibrary(shiny)\nlibrary(gt)\nlibrary(tidyverse)\n#####IOL power calculation\n######predicted ALP\nALP_min24 &lt;- function(AL, K1, K2){\n  Km &lt;- 2/(1/K1 + 1/K2)\n  CCR &lt;- 337.5/Km\n  ALP &lt;- 0.26755 *AL -0.35626 * CCR +1.56317\n  return(ALP)\n}\n##IOL : PCB00/ZCB00 = 1\n##Procedure :MCTR = 1\nALP_maj24 &lt;- function(WTW, Age, IOL, Procedure){\n  ALP &lt;- 0.190810 * WTW + 0.007952 * Age + 0.297651 * IOL - 0.263585 * Procedure\n  return(ALP)\n}\n\n#####predicted ELP\nELP_min24 &lt;- function(ALP, AL, K1, K2, WTW){\n  Km &lt;- 2/(1/K1 + 1/K2)\n  CCR &lt;- 337.5/Km\n  H &lt;- CCR - ((CCR)^2 - ((WTW - 1)/2)^2)^(1/2)\n  ELP &lt;- ALP *0.45967 + H * 0.79294 + AL *0.27593 -0.23519 *CCR -3.49273\n  return(ELP)\n}\n\n\nELP_maj24 &lt;- function(ALP, AL, K1, K2){\n  Km &lt;- 2/(1/K1 + 1/K2)\n  CCR &lt;- 337.5/Km\n  \n  ELP &lt;- ALP * 0.7368 + 0.3152 * AL -0.5416 * CCR -1.5633\n  return(ELP)\n}\n\n####adjust AL\n\nAL_optimized_min24 &lt;- function(AL){\n  AL_O &lt;- 1.10766 * AL - 2.17799\n  return(AL_O)\n}\n\nAL_optimized_maj24 &lt;- function(AL){\n  AL_O &lt;- 0.99574 * AL + 0.53407\n  return(AL_O)\n}\n\n#######MFFF\n\nrefraction &lt;- function(IOL_power, K1, K2, ELP,  AL){\n  na &lt;- 1.336\n  nc &lt;- 1.333\n  ncm1 &lt;- nc - 1\n  K &lt;- 2/(1/K1 + 1/K2)\n  V &lt;- 0.012\n  R &lt;- (337.5/K)\n  R &lt;- R*0.001\n  ELP &lt;- ELP* 0.001\n  AL &lt;- AL*0.001\n  m &lt;- na/(AL - ELP) - IOL_power\n  mm &lt;- na/m + ELP\n  mmm &lt;- na/mm - (ncm1/R)\n  mmmm &lt;- 1/mmm + V\n  ref &lt;- 1/mmmm\n  return(ref)\n}\n######calculate IOL power\n\nIOL_power_ref_0 &lt;- function(K1, K2, ELP,  AL){\n  na &lt;- 1.336\n  nc &lt;- 1.333\n  ncm1 &lt;- nc - 1\n  K &lt;- 2/(1/K1 + 1/K2)\n  V &lt;- 0.012\n  R &lt;- (337.5/K)\n  R &lt;- R*0.001\n  ELP &lt;- ELP* 0.001\n  AL &lt;- AL*0.001\n  aa &lt;- (na/(AL - ELP))\n  bb &lt;- na/(na/(ncm1/R) - ELP)\n  P &lt;- aa - bb\n  return(P)\n}\n\nIOL_power_ref &lt;- function(ref, K1, K2, ELP,  AL){\n  na &lt;- 1.336\n  nc &lt;- 1.333\n  ncm1 &lt;- nc - 1\n  K &lt;- 2/(1/K1 + 1/K2)\n  V &lt;- 0.012\n  R &lt;- (337.5/K)\n  R &lt;- R*0.001\n  ELP &lt;- ELP* 0.001\n  AL &lt;- AL*0.001\n  aa &lt;- (na/(AL - ELP))\n  cc &lt;- ncm1/R + 1/(1/ref - V)\n  bb &lt;- na/(na/cc - ELP)\n  P &lt;- aa - bb\n  return(P)\n}\n\n\n####T2_optimizAL\nrefraction_T2 &lt;- function(IOL_power, K1, K2, A,  AL, AL_O){\n  na &lt;- 1.336\n  nc &lt;- 1.333\n  ncm1 &lt;- nc - 1\n  K &lt;- 2/(1/K1 + 1/K2)\n  V &lt;- 0.012\n  R &lt;- (337.5/K)\n  \n  L &lt;- AL\n  ifelse(\n    L &lt;= 24.2,\n    LCOR &lt;- L,\n    ifelse(L &lt;36.2,\n           LCOR &lt;- 1.716*L-3.446-0.0237*L*L,\n           LCOR &lt;- 27.62)\n  )\n  H &lt;- -10.326 + 0.32630 * AL + 0.13533 * K\n  ACDcon &lt;- 0.62467*A - 68.747\n  offset_SRTK &lt;- ACDcon - 3.336\n  ACDest &lt;- (H + offset_SRTK) * 0.001\n  ACDest &lt;- ACDest \n  rethick &lt;- 0.65696 - 0.02020 * L\n  LOPT &lt;- (L + rethick) * 0.001\n  R &lt;- R *0.001\n  AL_O &lt;- AL_O * 0.001\n  m &lt;- na/(AL_O - ACDest) - IOL_power\n  mm &lt;- na/m + ACDest\n  mmm &lt;- na/mm - ncm1/R\n  mmmm &lt;- 1/mmm + V\n  ref &lt;- 1/mmmm\n  return(ref)\n}\n######calculate IOL power\n\nIOL_power_ref_0_T2 &lt;- function(K1, K2, A, AL_O,  AL){\n  na &lt;- 1.336\n  nc &lt;- 1.333\n  ncm1 &lt;- nc - 1\n  K &lt;- 2/(1/K1 + 1/K2)\n  V &lt;- 0.012\n  R &lt;- (337.5/K)\n  \n  L &lt;- AL\n  ifelse(\n    L &lt;= 24.2,\n    LCOR &lt;- L,\n    ifelse(L &lt;36.2,\n           LCOR &lt;- 1.716*L-3.446-0.0237*L*L,\n           LCOR &lt;- 27.62)\n  )\n  H &lt;- -10.326 + 0.32630 * AL + 0.13533 * K\n  ACDcon &lt;- 0.62467*A - 68.747\n  offset_SRTK &lt;- ACDcon - 3.336\n  ACDest &lt;- (H + offset_SRTK) * 0.001\n  ACDest &lt;- ACDest \n  rethick &lt;- 0.65696 - 0.02020 * L\n  LOPT &lt;- (L + rethick) * 0.001\n  R &lt;- R *0.001\n  ELP &lt;- ACDest\n  AL_O &lt;- AL_O * 0.001\n  aa &lt;- (na/(AL_O - ELP))\n  bb &lt;- na/(na/(ncm1/R) - ELP)\n  P &lt;- aa - bb\n  return(P)\n}\n\nIOL_power_ref_T2 &lt;- function(ref, K1, K2, AL_O, A,  AL){\n  na &lt;- 1.336\n  nc &lt;- 1.333\n  ncm1 &lt;- nc - 1\n  K &lt;- 2/(1/K1 + 1/K2)\n  V &lt;- 0.012\n  R &lt;- (337.5/K)\n  \n  L &lt;- AL\n  ifelse(\n    L &lt;= 24.2,\n    LCOR &lt;- L,\n    ifelse(L &lt;36.2,\n           LCOR &lt;- 1.716*L-3.446-0.0237*L*L,\n           LCOR &lt;- 27.62)\n  )\n  H &lt;- -10.326 + 0.32630 * AL + 0.13533 * K\n  ACDcon &lt;- 0.62467*A - 68.747\n  offset_SRTK &lt;- ACDcon - 3.336\n  ACDest &lt;- (H + offset_SRTK) * 0.001\n  ACDest &lt;- ACDest \n  rethick &lt;- 0.65696 - 0.02020 * L\n  LOPT &lt;- (L + rethick) * 0.001\n  R &lt;- R *0.001\n  ELP &lt;- ACDest\n  AL_O &lt;- AL_O * 0.001\n  aa &lt;- (na/(AL_O - ELP))\n  cc &lt;- ncm1/R + 1/(1/ref - V)\n  bb &lt;- na/(na/cc - ELP)\n  P &lt;- aa - bb\n  return(P)\n}\n\nZ_AL &lt;- function(Age, AL){\n    aget &lt;- Age\n    alt &lt;- AL\n    Z_AL &lt;- NA\n    Z_AL &lt;- ifelse(aget &gt;= 18,\n            (alt - 24.50)/1.03,\n           ifelse(aget &gt;= 17,\n                   (alt - 24.58)/1.14,\n                  ifelse(aget &gt;= 16,\n                          (alt - 24.65)/1.22,\n                         ifelse(aget&gt;= 15,\n                                 (alt - 24.50)/1.21,\n                                ifelse(aget&gt;=14,\n                                        (alt - 24.41)/1.30,\n                                       ifelse(aget&gt;=13,\n                                               (alt - 24.10)/1.17,\n                                              ifelse(aget&gt;= 12,\n                                                      (alt - 23.94)/1.08,\n                                                     ifelse(aget&gt;= 11,\n                                                             (alt - 23.77)/1.03,\n                                                            ifelse(aget&gt;= 10,\n                                                                    (alt - 23.58)/1.01,\n                                                                   ifelse(\n                                                                     aget&gt;= 9,\n                                                                      (alt - 23.34)/0.89,\n                                                                     ifelse(\n                                                                       aget&gt;=8,\n                                                                        (alt - 23.06)/0.88,\n                                                                       ifelse(\n                                                                         aget&gt;=7,\n                                                                          (alt - 22.76)/0.79,\n                                                                         ifelse(\n                                                                           aget&gt;=6,\n                                                                            (alt - 22.49)/0.75,\n                                                                           ifelse(\n                                                                             aget&gt;=5,\n                                                                              (alt - 22.31)/0.68,\n                                                                             ifelse(\n                                                                               aget&gt;=4,\n                                                                                (alt - 22.15)/0.72,\n                                                                               ifelse(\n                                                                                 aget&gt;=3,\n                                                                                  (alt - 22.10)/0.72,\n                                                                                 cccc &lt;- 1\n                                                                               )\n                                                                             )\n                                                                           )\n                                                                         )\n                                                                         \n                                                                       )\n                                                                     )\n                                                                   )\n                                                            )\n                                                     )\n                                              )\n                                       )\n                                       \n                                ))\n                  )\n           ))\n    return(Z_AL)\n  \n}\n\n\nclustertree &lt;- function(Age, Z_AL, AL, Apex, CCR){\n  cluster &lt;- NA\n  cluster &lt;- ifelse(Age &lt;12 & Z_AL &lt;1.5 & CCR &lt;8.5,\n                    \"A\",\n                    ifelse(Age &lt;12 & Z_AL &lt;1.5 & CCR &gt;= 8.5 & Apex &gt;=526,\n                           \"A\",\n                           ifelse(Age &lt;12 & Z_AL &lt;1.5 & CCR &gt;= 8.5 & Apex &lt;526,\n                                  \"B\",\n                                  ifelse(Age &lt;12 & Z_AL &gt;= 1.5 & Z_AL &gt;= 9,\n                                         \"D\",\n                                        ifelse(Age &lt;12 & Z_AL &gt;= 2.6 & Z_AL &lt; 9 ,\n                                               \"B\",\n                                               ifelse(Age &lt;12 & Z_AL &gt;= 1.5 & Z_AL &lt; 2.6 &CCR&lt;8.1,\n                                                      \"A\",\n                                                      ifelse(\n                                                        Age &lt;12 & Z_AL &gt;= 1.5 & Z_AL &lt; 2.6 &CCR&gt;=8.1 &Apex &gt;= 577,\n                                                        \"A\",\n                                                        ifelse(Age &lt;12 & Z_AL &gt;= 1.5 & Z_AL &lt; 2.6 &CCR&gt;=8.1 &Apex &lt; 577,\n                                                               \"B\",\n                                                               ifelse(\n                                                                 Age &gt;= 12 & AL &lt;28,\n                                                                 \"C\",\n                                                                 \"D\"\n                                                               )\n                                                          \n                                                        )\n                                                      )\n                                                 \n                                               )\n                                          \n                                        )\n                                    \n                                  )\n                           )\n                    ))\n  return(cluster)\n}\n\n# Define UI for application that draws a histogram\n\ngender_female_male &lt;- c(\"Female\", \"Male\")\neye_side &lt;- c(\"Right\", \"Left\")\nprocedures &lt;- c(\"MCTR\", \"CTR-CH\", \"SF-IOL\")\n\nui &lt;- page_fixed(\n  useShinyjs(),\n  tags$style(    \"\n    html, body {\n    max-width: 1300px; /* 设置页面最大宽度 */\n    margin: auto; /* 居中 */\n    width: 100%; /* 确保宽度为 100% */\n    }\n    \"),\n    layout_columns(\n    col_widths = c(4, 8),\n    card_image(\n      style = \"margin-top: 10px;\", # 添加底部间距\n      full_screen = TRUE,\n      file = \"sup1.png\",\n      style = \"display: flex; justify-content: center; align-items: center; max-height: 90%; max-width: 90%; object-fit: contain;\"\n    ),\n    card_body(\n      # 使用 HTML 和 CSS 来设置字号、居中、首行缩进和两侧对齐\n      HTML(\n        '&lt;div style=\"text-align: justify; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 0 15px;\"&gt;\n            &lt;p style=\"text-indent: 20px; font-size: 18px; line-height: 1.6;\"&gt;\n              Welcome to the &lt;b&gt;MFS with EL Clustering Tool!&lt;/b&gt; This website provides an innovative platform for risk stratification and treatment decision-making for patients with &lt;b&gt;Marfan syndrome&lt;/b&gt; and &lt;b&gt;ectopia lentis&lt;/b&gt;. Based on data from the EL cohort, our research leverages machine learning to identify &lt;b&gt;four distinct clinical phenotypes&lt;/b&gt;, offering valuable insights into prognosis and therapeutic response. By integrating real-world data and combining it with published &lt;a href=\"https://pubmed.ncbi.nlm.nih.gov/39663600/\" target=\"_blank\"&gt;IOL power calculation tools&lt;/a&gt;, the platform supports clinicians in tailoring personalized treatment strategies, including postoperative &lt;b&gt;PCO risk estimation&lt;/b&gt; and &lt;b&gt;IOL power calculation&lt;/b&gt;.\n            &lt;/p&gt;\n          &lt;/div&gt;'\n      )\n    )\n    )\n  ,\n  card(\n    full_screen = TRUE,\n    card_body(\n    fluidRow(\n      column(4, textInput(\"name\", label = span(\"Patient's name\", class = \"label custom-input\"), value = \"\")),\n             column(4, dateInput(\"dob\", label = span(\"Patient's birthday\", class = \"label custom-input\"), value = \"1993-12-22\")),\n             column(4, selectInput(\"Gender\", label = span(\"Patient's gender\", class = \"label custom-input\"), gender_female_male))\n      ),\n    fluidRow(\n      column(4, selectInput(\"eyeside\", label = span(\"Laterality\",  class = \"label custom-input\"), eye_side)),\n      column(4, textInput(\"surger\", label = span(\"Doctor's name\",  class = \"label custom-input\"), value = \"\")),\n      column(4, dateInput(\"Sob\", label = span(\"Surgery date\",  class = \"label custom-input\"), value = \"2025-5-15\"))\n    ),\n    fluidRow(\n      column(4, numericInput(\"AL\", label = span(\"AL (mm)\",  class = \"label custom-input\"), value = \"24.03\", step = 0.01)),\n      column(4, numericInput(\"WTW\", label = span(\"WTW (mm)\",  class = \"label custom-input\"), value = \"12.32\", step = 0.01)),\n      column(4, numericInput(\"APEX\", label = span(\"APEX (µm)\",  class = \"label custom-input\"), value = \"553\",step = 1))\n    ),\n    fluidRow(\n      column(4, numericInput(\"K1\", label = span(\"K1 (D)\",  class = \"label custom-input\"), value = \"41.21\",step = 0.01)),\n      column(4, numericInput(\"K2\", label = span(\"K2 (D)\",  class = \"label custom-input\"), value = \"42.33\",step = 0.01)),\n      column(4, numericInput(\"ref\", label = span(\"Target refraction (D)\",  class = \"label custom-input\"), value = \"-1\",step = 0.01))\n    ),\n    fluidRow(\n      column(4,offset = 2, selectInput(\"procedure\",label = span( \"Procedure\",  class = \"label custom-input\"),choices = c(\"MCTR\", \"CTR-CH\",\n                                                                                                              \"SF-IOL\"))),\n      column(4, selectInput(\"IOL_type\",label = span( \"IOL\",  class = \"label custom-input\"), \n                                choices = c(\"DCB00/ICB00/ZCB00\", \"SN60AT/SN60WF\",\"Rayner 920H/970C\"))\n    )\n    )))\n    ,\n  card(\n    actionButton(\"cal\", label = span(\"Extimate cluster and calculate IOL power\",class = \"label custom-input\"), class = \"btn-success\",\n                   icon = shiny::icon(\"calculator\"))\n  ),\n  tags$div(\n    id = \"plot_div\",\n    style = \"display:none;\",\n    \n    layout_columns(\n      col_widths = c(4, 8),\n      card(\n        div(\n          style = \"display: flex; justify-content: center; align-items: center; height: 100%;\",\n          uiOutput(\"words_cluster\")\n        )\n      ),\n      card(\n        div(\n          style = \"display: flex; justify-content: center; align-items: center; height: 100%;\",  \n          imageOutput(\"PCO_sur\", inline = TRUE)\n        )\n      )\n    )\n  ),\n  tags$div(\n    style = \"display: flex; justify-content: center; align-items: center; height: 100%;\",\n    uiOutput(\"conditional_layout\")\n  )\n)\n\n\n\nserver &lt;- function(input, output, session) {\n  \n  observeEvent(input$procedure, {\n    if (input$procedure %in% c(\"MCTR\", \"CTR-CH\")) {\n      # If the first input is A or B, update second input to D and E\n      updateSelectInput(session, \"IOL_type\", choices = c(\"DCB00/ICB00/ZCB00\", \"SN60AT/SN60WF\"))\n    } else if (input$procedure == \"SF-IOL\") {\n      # If the first input is C, update second input to F\n      updateSelectInput(session, \"IOL_type\", choices = \"Rayner 920H/970C\")\n    }\n  })\n  observeEvent(input$cal, {\n    \n    shinyjs::show(id = \"plot_div\")\n  })\n  \n  \n  calculateValues &lt;- eventReactive(input$cal, {\n   \n    if(input$Gender == \"Female\") {\n      gg &lt;- 0\n    } else {\n      gg &lt;- 1\n    }\n    \n    today &lt;- Sys.Date()\n    dob &lt;- as.Date(input$dob)\n    surgery_date &lt;- as.Date(input$Sob)\n    aa &lt;- as.numeric(difftime(surgery_date, dob, units = \"days\")) / 365.25\n    ccrz &lt;- 337.5/(2/(1/input$K1 + 1/input$K2))\n    # 执行全部计算逻辑，并将结果作为列表返回\n    ALP_M_P = if(input$AL &gt; 24) {\n      ALP_maj24(WTW = input$WTW, Age = aa, IOL = 1,  Procedure = 1)\n    } else {\n      ALP_min24(AL = input$AL, K1 = input$K1, K2 = input$K2 )\n    }\n    \n    ALP_M_S = if(input$AL &gt; 24) {\n      ALP_maj24(WTW = input$WTW, Age = aa, IOL = 0,  Procedure = 1)\n    } else {\n      ALP_min24(AL = input$AL, K1 = input$K1, K2 = input$K2 )\n    }\n    \n    ALP_C_P = if(input$AL &gt; 24) {\n      ALP_maj24(WTW = input$WTW, Age = aa, IOL = 1,  Procedure = 0)\n    } else {\n      ALP_min24(AL = input$AL, K1 = input$K1, K2 = input$K2 )\n    }\n    \n    ALP_C_S = if(input$AL &gt; 24) {\n      ALP_maj24(WTW = input$WTW, Age = aa, IOL = 0,  Procedure = 0)\n    } else {\n      ALP_min24(AL = input$AL, K1 = input$K1, K2 = input$K2 )\n    }\n    \n    \n    ELP_M_P = if(input$AL &gt; 24) {\n      ELP_maj24(ALP = ALP_M_P, AL = input$AL, K1 = input$K1, K2 = input$K2)\n    } else {\n      ELP_min24(ALP = ALP_M_P, AL = input$AL, K1 = input$K1, K2 = input$K2,\n                WTW = input$WTW)\n    }\n    \n    ELP_M_S = if(input$AL &gt; 24) {\n      ELP_maj24(ALP = ALP_M_S, AL = input$AL, K1 = input$K1, K2 = input$K2)\n    } else {\n      ELP_min24(ALP = ALP_M_S, AL = input$AL, K1 = input$K1, K2 = input$K2,\n                WTW = input$WTW)\n    }\n    \n    ELP_C_P = if(input$AL &gt; 24) {\n      ELP_maj24(ALP = ALP_C_P, AL = input$AL, K1 = input$K1, K2 = input$K2)\n    } else {\n      ELP_min24(ALP = ALP_C_P, AL = input$AL, K1 = input$K1, K2 = input$K2,\n                WTW = input$WTW)\n    }\n    \n    ELP_C_S = if(input$AL &gt; 24) {\n      ELP_maj24(ALP = ALP_C_S, AL = input$AL, K1 = input$K1, K2 = input$K2)\n    } else {\n      ELP_min24(ALP = ALP_C_S, AL = input$AL, K1 = input$K1, K2 = input$K2,\n                WTW = input$WTW)\n    }\n    \n    AL_optimized = if(input$AL &gt; 24) {\n      AL_optimized_maj24(AL = input$AL)\n    } else {\n      AL_optimized_min24(AL = input$AL)\n    }\n    \n    ZAL = Z_AL(Age = aa,\n               AL = input$AL)\n    clus = clustertree(AL = input$AL,\n                       Z_AL = ZAL,\n                       Age = aa,\n                       Apex = input$APEX,\n                       CCR = ccrz\n                   )\n    \n    return(list(\n      ALP_M_P = ALP_M_P,\n      ALP_M_S = ALP_M_S,\n      ALP_C_P = ALP_C_P,\n      ALP_C_S = ALP_C_S,\n      ELP_M_P = ELP_M_P,\n      ELP_M_S = ELP_M_S,\n      ELP_C_P = ELP_C_P,\n      ELP_C_S = ELP_C_S,\n      AL_optimized = AL_optimized,\n      aa = aa,\n      ZAL = ZAL,\n      clus = clus\n    ))\n  }\n  )\n  \n  table_reactive &lt;- eventReactive(input$cal,{\n    values &lt;- calculateValues()\n    aa &lt;- values$aa\n    clus &lt;- values$clus\n    \n    if(aa &lt;= 15){\n      if(clus == \"A\"){\n        AL_15 &lt;- 1.67 * log10(aa +0.6) +21.71\n      }else{\n        if(clus == \"B\"){\n          AL_15 &lt;- 7.2 * log10(aa +0.6) +19.69\n        }else{\n          AL_15 &lt;- input$AL\n        }\n      }\n    }else(\n      AL_15 &lt;- input$AL\n    )\n    \n    if(AL_15 &gt; 24) {\n      AL_optimized_15 &lt;-AL_optimized_maj24(AL = AL_15)\n    } else {\n      AL_optimized_15 &lt;-AL_optimized_min24(AL = AL_15)\n    }\n    table_M_S &lt;- data.frame(x = c(NA, NA, NA, NA, NA, NA), \n                            y = NA, z = NA, d = NA, e = NA, \n                            f = NA, g =NA, t = NA, n = NA)\n    colnames(table_M_S) &lt;- c(\"IOL\", \"IOL Power\", \"Refraction\",\n                             \"AL\", \"K1\", \"K2\", \"WTW\", \"Gender\", \"ELP\")\n    table_M_S$IOL &lt;- \"SN60AT/SN60WT\"\n    table_M_S$AL &lt;- input$AL\n    table_M_S$K1 &lt;- input$K1\n    table_M_S$K2 &lt;- input$K2\n    table_M_S$WTW &lt;- input$WTW\n    table_M_S$Gender &lt;- input$Gender\n    table_M_S$ELP &lt;- values$ELP_M_S\n    \n    IOLPref0_M_S &lt;- IOL_power_ref_0(AL = input$AL,\n                                    K1 = input$K1,\n                                    K2 = input$K2,\n                                    ELP = values$ELP_M_S)\n    \n    table_M_S[6, 2] &lt;- IOLPref0_M_S \n    \n    table_M_S[6, 3] &lt;- 0 \n    \n    if(input$ref == 0){\n      \n      med_IOLP_M_S &lt;- as.numeric((round(IOLPref0_M_S/0.5))*0.5)\n      \n      M_S_list &lt;- c(med_IOLP_M_S +1, med_IOLP_M_S+0.5, med_IOLP_M_S, med_IOLP_M_S-0.5,med_IOLP_M_S-1)\n      \n      table_M_S[1:5, 2] &lt;- M_S_list\n      \n      table_M_S[1:5, 3] &lt;- refraction(\n        IOL_power = table_M_S[1:5, 2],\n        K1 = table_M_S[1:5, 5],\n        K2 = table_M_S[1:5, 6],\n        ELP = table_M_S[1:5, 9],  \n        AL = table_M_S[1:5, 4])}else{\n          \n          IOLP_M_S_ref &lt;-   IOL_power_ref(\n            ref = input$ref,\n            K1 = input$K1,\n            K2 = input$K2,\n            ELP = values$ELP_M_S,\n            AL = input$AL\n          )\n          \n          med_IOLP_M_S &lt;- as.numeric((round(IOLP_M_S_ref/0.5))*0.5)\n          \n          M_S_list &lt;- c(med_IOLP_M_S +1, med_IOLP_M_S+0.5, med_IOLP_M_S, med_IOLP_M_S-0.5,med_IOLP_M_S-1)\n          \n          table_M_S[1:5, 2] &lt;- M_S_list\n          \n          table_M_S[1:5, 3] &lt;- refraction(\n            IOL_power = table_M_S[1:5, 2],\n            K1 = table_M_S[1:5, 5],\n            K2 = table_M_S[1:5, 6],\n            ELP = table_M_S[1:5, 9],  \n            AL = table_M_S[1:5, 4])}\n    \n    tableM_S &lt;- table_M_S\n    \n    tableM_S &lt;- tableM_S[, 2:3]\n    tableM_S_15 &lt;- tableM_S\n    tableM_S_15$`Refraction at 15y` &lt;- refraction(\n      IOL_power = tableM_S_15[,1],\n      K1 = input$K1,\n      K2 = input$K2,\n      ELP = values$ELP_M_S,  \n      AL = AL_15)\n    tableM_S &lt;- as.data.frame(tableM_S)\n    tableM_S[, 1] &lt;- round(tableM_S[, 1], 2)\n    tableM_S[, 2] &lt;- round(tableM_S[, 2], 2)\n    tableM_S_15 &lt;- as.data.frame(tableM_S_15)\n    tableM_S_15[,1] &lt;- round(tableM_S_15[,1],2)\n    tableM_S_15[,2]&lt;- round(tableM_S_15[,2],2)\n    tableM_S_15[,3]&lt;- round(tableM_S_15[,3],2)\n    \n    \n    table_M_P &lt;- data.frame(x = c(NA, NA, NA, NA, NA, NA), \n                            y = NA, z = NA, d = NA, e = NA, \n                            f = NA, g =NA, t = NA, n = NA)\n    colnames(table_M_P) &lt;- c(\"IOL\", \"IOL Power\", \"Refraction\",\n                             \"AL\", \"K1\", \"K2\", \"WTW\", \"Gender\", \"ELP\")\n    table_M_P$IOL &lt;- \"SN60AT/SN60WT\"\n    table_M_P$AL &lt;- input$AL\n    table_M_P$K1 &lt;- input$K1\n    table_M_P$K2 &lt;- input$K2\n    table_M_P$WTW &lt;- input$WTW\n    table_M_P$Gender &lt;- input$Gender\n    table_M_P$ELP &lt;- values$ELP_M_P\n    \n    IOLPref0_M_P &lt;- IOL_power_ref_0(AL = input$AL,\n                                    K1 = input$K1,\n                                    K2 = input$K2,\n                                    ELP = values$ELP_M_P)\n    \n    table_M_P[6, 2] &lt;- IOLPref0_M_P \n    \n    table_M_P[6, 3] &lt;- 0 \n    \n    if(input$ref == 0){\n      \n      med_IOLP_M_P &lt;- as.numeric((round(IOLPref0_M_P/0.5))*0.5)\n      \n      M_P_list &lt;- c(med_IOLP_M_P +1, med_IOLP_M_P+0.5, med_IOLP_M_P, med_IOLP_M_P-0.5,med_IOLP_M_P-1)\n      \n      table_M_P[1:5, 2] &lt;- M_P_list\n      \n      table_M_P[1:5, 3] &lt;- refraction(\n        IOL_power = table_M_P[1:5, 2],\n        K1 = table_M_P[1:5, 5],\n        K2 = table_M_P[1:5, 6],\n        ELP = table_M_P[1:5, 9],  \n        AL = table_M_P[1:5, 4])}else{\n          \n          IOLP_M_P_ref &lt;-   IOL_power_ref(\n            ref = input$ref,\n            K1 = input$K1,\n            K2 = input$K2,\n            ELP = values$ELP_M_P,\n            AL = input$AL\n          )\n          \n          med_IOLP_M_P &lt;- as.numeric((round(IOLP_M_P_ref/0.5))*0.5)\n          \n          M_P_list &lt;- c(med_IOLP_M_P +1, med_IOLP_M_P+0.5, med_IOLP_M_P, med_IOLP_M_P-0.5,med_IOLP_M_P-1)\n          \n          table_M_P[1:5, 2] &lt;- M_P_list\n          \n          table_M_P[1:5, 3] &lt;- refraction(\n            IOL_power = table_M_P[1:5, 2],\n            K1 = table_M_P[1:5, 5],\n            K2 = table_M_P[1:5, 6],\n            ELP = table_M_P[1:5, 9],  \n            AL = table_M_P[1:5, 4])}\n    tableM_P &lt;- table_M_P\n    tableM_P &lt;- tableM_P[, 2:3]\n    tableM_P_15 &lt;- tableM_P\n    tableM_P_15$`Refraction at 15y` &lt;- refraction(\n      IOL_power = tableM_P_15[,1],\n      K1 = input$K1,\n      K2 = input$K2,\n      ELP = values$ELP_M_P,  \n      AL = AL_15)\n    tableM_P &lt;- as.data.frame(tableM_P)\n    tableM_P[, 1] &lt;- round(tableM_P[, 1], 2)\n    tableM_P[, 2] &lt;- round(tableM_P[, 2], 2)\n    tableM_P_15 &lt;- as.data.frame(tableM_P_15)\n    tableM_P_15[,1] &lt;- round(tableM_P_15[,1],2)\n    tableM_P_15[,2]&lt;- round(tableM_P_15[,2],2)\n    tableM_P_15[,3]&lt;- round(tableM_P_15[,3],2)\n    \n    \n    table_C_S &lt;- data.frame(x = c(NA, NA, NA, NA, NA, NA), \n                            y = NA, z = NA, d = NA, e = NA, \n                            f = NA, g =NA, t = NA, n = NA)\n    colnames(table_C_S) &lt;- c(\"IOL\", \"IOL Power\", \"Refraction\",\n                             \"AL\", \"K1\", \"K2\", \"WTW\", \"Gender\", \"ELP\")\n    table_C_S$IOL &lt;- \"SN60AT/SN60WT\"\n    table_C_S$AL &lt;- input$AL\n    table_C_S$K1 &lt;- input$K1\n    table_C_S$K2 &lt;- input$K2\n    table_C_S$WTW &lt;- input$WTW\n    table_C_S$Gender &lt;- input$Gender\n    table_C_S$ELP &lt;- values$ELP_C_S\n    \n    IOLPref0_C_S &lt;- IOL_power_ref_0(AL = input$AL,\n                                    K1 = input$K1,\n                                    K2 = input$K2,\n                                    ELP = values$ELP_C_S)\n    \n    table_C_S[6, 2] &lt;- IOLPref0_C_S \n    \n    table_C_S[6, 3] &lt;- 0 \n    \n    if(input$ref == 0){\n      \n      med_IOLP_C_S &lt;- as.numeric((round(IOLPref0_C_S/0.5))*0.5)\n      \n      C_S_list &lt;- c(med_IOLP_C_S +1, med_IOLP_C_S+0.5, med_IOLP_C_S, med_IOLP_C_S-0.5,med_IOLP_C_S-1)\n      \n      table_C_S[1:5, 2] &lt;- C_S_list\n      \n      table_C_S[1:5, 3] &lt;- refraction(\n        IOL_power = table_C_S[1:5, 2],\n        K1 = table_C_S[1:5, 5],\n        K2 = table_C_S[1:5, 6],\n        ELP = table_C_S[1:5, 9],  \n        AL = table_C_S[1:5, 4])}else{\n          \n          IOLP_C_S_ref &lt;-   IOL_power_ref(\n            ref = input$ref,\n            K1 = input$K1,\n            K2 = input$K2,\n            ELP = values$ELP_C_S,\n            AL = input$AL\n          )\n          \n          med_IOLP_C_S &lt;- as.numeric((round(IOLP_C_S_ref/0.5))*0.5)\n          \n          C_S_list &lt;- c(med_IOLP_C_S +1, med_IOLP_C_S+0.5, med_IOLP_C_S, med_IOLP_C_S-0.5,med_IOLP_C_S-1)\n          \n          table_C_S[1:5, 2] &lt;- C_S_list\n          \n          table_C_S[1:5, 3] &lt;- refraction(\n            IOL_power = table_C_S[1:5, 2],\n            K1 = table_C_S[1:5, 5],\n            K2 = table_C_S[1:5, 6],\n            ELP = table_C_S[1:5, 9],  \n            AL = table_C_S[1:5, 4])}\n    tableC_S &lt;- table_C_S\n    tableC_S &lt;- tableC_S[, 2:3]\n    tableC_S_15 &lt;- tableC_S\n    tableC_S_15$`Refraction at 15y` &lt;- refraction(\n      IOL_power = tableC_S_15[,1],\n      K1 = input$K1,\n      K2 = input$K2,\n      ELP = values$ELP_C_S,  \n      AL = AL_15)\n    tableC_S &lt;- as.data.frame(tableC_S)\n    tableC_S[, 1] &lt;- round(tableC_S[, 1], 2)\n    tableC_S[, 2] &lt;- round(tableC_S[, 2], 2)\n    tableC_S_15 &lt;- as.data.frame(tableC_S_15)\n    tableC_S_15[,1] &lt;- round(tableC_S_15[,1],2)\n    tableC_S_15[,2]&lt;- round(tableC_S_15[,2],2)\n    tableC_S_15[,3]&lt;- round(tableC_S_15[,3],2)\n    \n    \n    table_C_P &lt;- data.frame(x = c(NA, NA, NA, NA, NA, NA), \n                            y = NA, z = NA, d = NA, e = NA, \n                            f = NA, g =NA, t = NA, n = NA)\n    colnames(table_C_P) &lt;- c(\"IOL\", \"IOL Power\", \"Refraction\",\n                             \"AL\", \"K1\", \"K2\", \"WTW\", \"Gender\", \"ELP\")\n    table_C_P$IOL &lt;- \"SN60AT/SN60WT\"\n    table_C_P$AL &lt;- input$AL\n    table_C_P$K1 &lt;- input$K1\n    table_C_P$K2 &lt;- input$K2\n    table_C_P$WTW &lt;- input$WTW\n    table_C_P$Gender &lt;- input$Gender\n    table_C_P$ELP &lt;- values$ELP_C_P\n    \n    IOLPref0_C_P &lt;- IOL_power_ref_0(AL = input$AL,\n                                    K1 = input$K1,\n                                    K2 = input$K2,\n                                    ELP = values$ELP_C_P)\n    \n    table_C_P[6, 2] &lt;- IOLPref0_C_P \n    \n    table_C_P[6, 3] &lt;- 0 \n    \n    if(input$ref == 0){\n      \n      med_IOLP_C_P &lt;- as.numeric((round(IOLPref0_C_P/0.5))*0.5)\n      \n      C_P_list &lt;- c(med_IOLP_C_P +1, med_IOLP_C_P+0.5, med_IOLP_C_P, med_IOLP_C_P-0.5,med_IOLP_C_P-1)\n      \n      table_C_P[1:5, 2] &lt;- C_P_list\n      \n      table_C_P[1:5, 3] &lt;- refraction(\n        IOL_power = table_C_P[1:5, 2],\n        K1 = table_C_P[1:5, 5],\n        K2 = table_C_P[1:5, 6],\n        ELP = table_C_P[1:5, 9],  \n        AL = table_C_P[1:5, 4])}else{\n          \n          IOLP_C_P_ref &lt;-   IOL_power_ref(\n            ref = input$ref,\n            K1 = input$K1,\n            K2 = input$K2,\n            ELP = values$ELP_C_P,\n            AL = input$AL\n          )\n          \n          med_IOLP_C_P &lt;- as.numeric((round(IOLP_C_P_ref/0.5))*0.5)\n          \n          C_P_list &lt;- c(med_IOLP_C_P +1, med_IOLP_C_P+0.5, med_IOLP_C_P, med_IOLP_C_P-0.5,med_IOLP_C_P-1)\n          \n          table_C_P[1:5, 2] &lt;- C_P_list\n          \n          table_C_P[1:5, 3] &lt;- refraction(\n            IOL_power = table_C_P[1:5, 2],\n            K1 = table_C_P[1:5, 5],\n            K2 = table_C_P[1:5, 6],\n            ELP = table_C_P[1:5, 9],  \n            AL = table_C_P[1:5, 4])}\n    tableC_P &lt;- table_C_P\n    tableC_P &lt;- tableC_P[, 2:3]\n    tableC_P_15 &lt;- tableC_P\n    tableC_P_15$`Refraction at 15y` &lt;- refraction(\n      IOL_power = tableC_P_15[,1],\n      K1 = input$K1,\n      K2 = input$K2,\n      ELP = values$ELP_C_P,  \n      AL = AL_15)\n    tableC_P &lt;- as.data.frame(tableC_P)\n    tableC_P[, 1] &lt;- round(tableC_P[, 1], 2)\n    tableC_P[, 2] &lt;- round(tableC_P[, 2], 2)\n    tableC_P_15 &lt;- as.data.frame(tableC_P_15)\n    tableC_P_15[,1] &lt;- round(tableC_P_15[,1],2)\n    tableC_P_15[,2]&lt;- round(tableC_P_15[,2],2)\n    tableC_P_15[,3]&lt;- round(tableC_P_15[,3],2)\n    \n    \n    table_R &lt;- data.frame(x = c(NA, NA, NA, NA, NA, NA), \n                          y = NA, z = NA, d = NA, e = NA, \n                          f = NA, g =NA, t = NA, n = NA)\n    colnames(table_R) &lt;- c(\"IOL\", \"IOL Power\", \"Refraction\",\n                           \"AL\", \"K1\", \"K2\", \"WTW\", \"Gender\", \"ALP_O\")\n    table_R$IOL &lt;- \"SN60AT/SN60WT\"\n    table_R$AL &lt;- input$AL\n    table_R$K1 &lt;- input$K1\n    table_R$K2 &lt;- input$K2\n    table_R$WTW &lt;- input$WTW\n    table_R$Gender &lt;- input$Gender\n    table_R$ALP_O &lt;- values$AL_optimized\n    \n    IOLPref0_R &lt;- IOL_power_ref_0_T2(AL = input$AL,\n                                     K1 = input$K1,\n                                     K2 = input$K2,\n                                     AL_O = values$AL_optimized,\n                                     A = 118.3)\n    \n    table_R[6, 2] &lt;- IOLPref0_R \n    \n    table_R[6, 3] &lt;- 0 \n    \n    if(input$ref == 0){\n      \n      med_IOLP_R &lt;- as.numeric((round(IOLPref0_R/0.5))*0.5)\n      \n      R_list &lt;- c(med_IOLP_R +1, med_IOLP_R+0.5, med_IOLP_R, med_IOLP_R-0.5,med_IOLP_R-1)\n      \n      table_R[1:5, 2] &lt;- R_list\n      \n      table_R[1:5, 3] &lt;- refraction_T2(\n        IOL_power = table_R[1:5, 2],\n        K1 = table_R[1:5, 5],\n        K2 = table_R[1:5, 6],\n        AL_O  = table_R[1:5, 9],  \n        AL = table_R[1:5, 4],\n        A = 118.3)}else{\n          \n          IOLP_R_ref &lt;-   IOL_power_ref_T2(\n            ref = input$ref,\n            K1 = input$K1,\n            K2 = input$K2,\n            AL_O  = values$AL_optimized,\n            AL = input$AL,\n            A = 118.3\n          )\n          \n          med_IOLP_R &lt;- as.numeric((round(IOLP_R_ref/0.5))*0.5)\n          \n          R_list &lt;- c(med_IOLP_R +1, med_IOLP_R+0.5, med_IOLP_R, med_IOLP_R-0.5,med_IOLP_R-1)\n          \n          table_R[1:5, 2] &lt;- R_list\n          \n          table_R[1:5, 3] &lt;- refraction_T2(\n            IOL_power = table_R[1:5, 2],\n            K1 = table_R[1:5, 5],\n            K2 = table_R[1:5, 6],\n            AL_O = table_R[1:5, 9],  \n            AL = table_R[1:5, 4],\n            A = 118.3)\n        }\n    tableR &lt;- table_R\n    tableR &lt;- tableR[, 2:3]\n    tableR_15 &lt;- tableR\n    tableR_15$`Refraction at 15y` &lt;- refraction_T2(\n      IOL_power = tableR_15[,1],\n      K1 = input$K1,\n      K2 = input$K2,\n      AL_O = AL_optimized_15,  \n      AL = AL_15,\n      A = 118.3)\n    tableR &lt;- as.data.frame(tableR)\n    tableR[, 1] &lt;- round(tableR[, 1], 2)\n    tableR[, 2] &lt;- round(tableR[, 2], 2)\n    tableR_15 &lt;- as.data.frame(tableR_15)\n    tableR_15[,1] &lt;- round(tableR_15[,1],2)\n    tableR_15[,2]&lt;- round(tableR_15[,2],2)\n    tableR_15[,3]&lt;- round(tableR_15[,3],2)\n    \n    \n    \n    table &lt;-  if(aa &gt; 15){if(input$procedure == \"MCTR\" & input$IOL_type == \"DCB00/ICB00/ZCB00\"){\n      \n      table &lt;- tableM_P\n      \n      \n    } else if(input$procedure == \"MCTR\" & input$IOL_type == \"SN60AT/SN60WF\"){\n      \n      table &lt;- tableM_S\n      \n      \n    } else if(input$procedure == \"CTR-CH\" & input$IOL_type == \"DCB00/ICB00/ZCB00\"){\n      \n      table &lt;- tableC_P\n      \n      \n    } else if(input$procedure == \"CTR-CH\" & input$IOL_type == \"SN60AT/SN60WF\"){\n      \n      table &lt;- tableC_S\n      \n      \n    } else if(input$procedure == \"SF-IOL\" & input$IOL_type == \"Rayner 920H/970C\"){\n      \n      table &lt;- tableR\n      \n      \n    }}else{\n      if(clus %in% c(\"C\", \"D\")){\n        if(input$procedure == \"MCTR\" & input$IOL_type == \"DCB00/ICB00/ZCB00\"){\n          \n          table &lt;- tableM_P\n          \n          \n        } else if(input$procedure == \"MCTR\" & input$IOL_type == \"SN60AT/SN60WF\"){\n          \n          table &lt;- tableM_S\n          \n          \n        } else if(input$procedure == \"CTR-CH\" & input$IOL_type == \"DCB00/ICB00/ZCB00\"){\n          \n          table &lt;- tableC_P\n          \n          \n        } else if(input$procedure == \"CTR-CH\" & input$IOL_type == \"SN60AT/SN60WF\"){\n          \n          table &lt;- tableC_S\n          \n          \n        } else if(input$procedure == \"SF-IOL\" & input$IOL_type == \"Rayner 920H/970C\"){\n          \n          table &lt;- tableR\n        } \n      }else{\n        if(input$procedure == \"MCTR\" & input$IOL_type == \"DCB00/ICB00/ZCB00\"){\n          \n          table &lt;- tableM_P_15\n          \n          \n        } else if(input$procedure == \"MCTR\" & input$IOL_type == \"SN60AT/SN60WF\"){\n          \n          table &lt;- tableM_S_15\n          \n          \n        } else if(input$procedure == \"CTR-CH\" & input$IOL_type == \"DCB00/ICB00/ZCB00\"){\n          \n          table &lt;- tableC_P_15\n          \n          \n        } else if(input$procedure == \"CTR-CH\" & input$IOL_type == \"SN60AT/SN60WF\"){\n          \n          table &lt;- tableC_S_15\n          \n          \n        } else if(input$procedure == \"SF-IOL\" & input$IOL_type == \"Rayner 920H/970C\"){\n          \n          table &lt;- tableR_15\n        }\n      }\n    }\n    table\n    datatable(table,\n              selection = 'none') %&gt;%\n      formatStyle(\n        columns = 1:ncol(table),  # 应用到所有列\n        valueColumns = NULL,           # 或者指定单列：比如 c('column_name')\n        target = 'row',\n        backgroundColor = styleEqual(3, '#D3D3D3')# 第三行的背景颜色加深\n      )%&gt;%\n      formatStyle(\n        columns = 1:ncol(table),  # 应用到所有列\n        valueColumns = NULL,           # 或者指定单列：比如 c('column_name')\n        target = 'row',\n        backgroundColor = styleEqual(6, '#D3D3D3')# 第三行的背景颜色加深\n      )\n    # 返回处理和格式化后的 data.frame，以便用于渲染或传递\n    datatable(table, selection = 'none')\n  })\n  #A = 118.3\n  IOL_types &lt;- eventReactive(input$cal, {\n    IOL_types &lt;- c(\"PCB00/ZCB00\",\"SN60AT/SN60WF\")\n  })\n  words_M_P_val &lt;- eventReactive(input$cal, {\n    # 构建 words_P 字符串或者 HTML 内容\n    HTML(paste0(\"&lt;b&gt;MCTR&lt;b&gt;\",\"&lt;br&gt;\", \n                \"&lt;br&gt;\", \n                \"&lt;b&gt;IOL: &lt;b&gt;\", \"PCB00/ZCB00\",  \"&lt;br&gt;\", \n                \"&lt;br&gt;\",\n                \"&lt;b&gt;Patient: &lt;b&gt;\", input$name, \"&lt;br&gt;\",\n                \"&lt;br&gt;\",\n                \"&lt;b&gt;DOB: &lt;b&gt;\", format(input$dob, \"%Y-%m-%d\"), \"&lt;br&gt;\",\n                \"&lt;br&gt;\",\n                \"&lt;b&gt;Doctor: &lt;b&gt;\", input$surger, \"&lt;br&gt;\",\n                \"&lt;br&gt;\",\n                \"&lt;b&gt;Surgery Date: &lt;b&gt;\", format(input$Sob, \"%Y-%m-%d\")))\n  })\n  words_M_S_val &lt;- eventReactive(input$cal, {\n    # 构建 words_P 字符串或者 HTML 内容\n    HTML(paste0(\"&lt;b&gt;MCTR&lt;b&gt;\",\"&lt;br&gt;\", \n                \"&lt;br&gt;\", \n                \"&lt;b&gt;IOL: &lt;b&gt;\", \"SN60AT/SN60WF\",  \"&lt;br&gt;\", \n                \"&lt;br&gt;\",\n                \"&lt;b&gt;Patient: &lt;b&gt;\", input$name, \"&lt;br&gt;\",\n                \"&lt;br&gt;\",\n                \"&lt;b&gt;DOB: &lt;b&gt;\", format(input$dob, \"%Y-%m-%d\"), \"&lt;br&gt;\",\n                \"&lt;br&gt;\",\n                \"&lt;b&gt;Doctor: &lt;b&gt;\", input$surger, \"&lt;br&gt;\",\n                \"&lt;br&gt;\",\n                \"&lt;b&gt;Surgery Date: &lt;b&gt;\", format(input$Sob, \"%Y-%m-%d\")))\n  })\n  \n  words_C_P_val &lt;- eventReactive(input$cal, {\n    # 构建 words_P 字符串或者 HTML 内容\n    HTML(paste0(\"&lt;b&gt;CTR-CH&lt;b&gt;\",\"&lt;br&gt;\", \n                \"&lt;br&gt;\", \n                \"&lt;b&gt;IOL: &lt;b&gt;\", \"PCB00/ZCB00\",  \"&lt;br&gt;\", \n                \"&lt;br&gt;\",\n                \"&lt;b&gt;Patient: &lt;b&gt;\", input$name, \"&lt;br&gt;\",\n                \"&lt;br&gt;\",\n                \"&lt;b&gt;DOB: &lt;b&gt;\", format(input$dob, \"%Y-%m-%d\"), \"&lt;br&gt;\",\n                \"&lt;br&gt;\",\n                \"&lt;b&gt;Doctor: &lt;b&gt;\", input$surger, \"&lt;br&gt;\",\n                \"&lt;br&gt;\",\n                \"&lt;b&gt;Surgery Date: &lt;b&gt;\", format(input$Sob, \"%Y-%m-%d\")))\n  })\n  words_C_S_val &lt;- eventReactive(input$cal, {\n    # 构建 words_P 字符串或者 HTML 内容\n    HTML(paste0(\"&lt;b&gt;CTR-CH&lt;b&gt;\",\"&lt;br&gt;\", \n                \"&lt;br&gt;\", \n                \"&lt;b&gt;IOL: &lt;b&gt;\", \"SN60AT/SN60WF\",  \"&lt;br&gt;\", \n                \"&lt;br&gt;\",\n                \"&lt;b&gt;Patient: &lt;b&gt;\", input$name, \"&lt;br&gt;\",\n                \"&lt;br&gt;\",\n                \"&lt;b&gt;DOB: &lt;b&gt;\", format(input$dob, \"%Y-%m-%d\"), \"&lt;br&gt;\",\n                \"&lt;br&gt;\",\n                \"&lt;b&gt;Doctor: &lt;b&gt;\", input$surger, \"&lt;br&gt;\",\n                \"&lt;br&gt;\",\n                \"&lt;b&gt;Surgery Date: &lt;b&gt;\", format(input$Sob, \"%Y-%m-%d\")))\n  })\n  words_R_val &lt;- eventReactive(input$cal, {\n    # 构建 words_P 字符串或者 HTML 内容\n    HTML(paste0(\"&lt;b&gt;SF-IOL&lt;b&gt;\",\"&lt;br&gt;\", \n                \"&lt;br&gt;\", \n                \"&lt;b&gt;IOL: &lt;b&gt;\", \"SN60AT/SN60WF\",  \"&lt;br&gt;\", \n                \"&lt;br&gt;\",\n                \"&lt;b&gt;Patient: &lt;b&gt;\", input$name, \"&lt;br&gt;\",\n                \"&lt;br&gt;\",\n                \"&lt;b&gt;DOB: &lt;b&gt;\", format(input$dob, \"%Y-%m-%d\"), \"&lt;br&gt;\",\n                \"&lt;br&gt;\",\n                \"&lt;b&gt;Doctor: &lt;b&gt;\", input$surger, \"&lt;br&gt;\",\n                \"&lt;br&gt;\",\n                \"&lt;b&gt;Surgery Date: &lt;b&gt;\", format(input$Sob, \"%Y-%m-%d\")))\n  })\n  word_val &lt;- eventReactive(input$cal, {\n    \n    # 构建 words_P 字符串或者 HTML 内容\n    HTML(paste0(\"&lt;b&gt;Patient: &lt;b&gt;\", input$name, \"   \",\"&lt;b&gt;DOB: &lt;b&gt;\", format(input$dob, \"%Y-%m-%d\"),  \"&lt;br&gt;\", \n                \"&lt;br&gt;\",\n                \"&lt;b&gt;Procedure：&lt;b&gt;\",input$procedure,\"   \", \"&lt;b&gt;IOL: &lt;b&gt;\", input$IOL_type,  \"&lt;br&gt;\", \n                \"&lt;br&gt;\",\n                \"&lt;b&gt;Doctor: &lt;b&gt;\", input$surger, \"   \",\"&lt;b&gt;Surgery Date: &lt;b&gt;\", format(input$Sob, \"%Y-%m-%d\")))\n    \n  })\n  word_val_15 &lt;- eventReactive(input$cal, {\n    values &lt;- calculateValues()\n    aa &lt;- values$aa\n    clus &lt;- values$clus\n    \n    if(aa &lt;= 15){\n      if(clus == \"A\"){\n        AL_15 &lt;- 1.67 * log10(aa +0.6) +21.71\n      }else{\n        if(clus == \"B\"){\n          AL_15 &lt;- 7.2 * log10(aa +0.6) +19.69\n        }else{\n          AL_15 &lt;- input$AL\n        }\n      }\n    }else(\n      AL_15 &lt;- input$AL\n    )\n    AL_15 &lt;- round(AL_15, 2)\n    # 构建 words_P 字符串或者 HTML 内容\n    HTML(paste0(\"&lt;b&gt;Patient: &lt;b&gt;\", input$name, \"   \",\"&lt;b&gt;DOB: &lt;b&gt;\", format(input$dob, \"%Y-%m-%d\"),  \"&lt;br&gt;\", \n                \"&lt;br&gt;\",\n                \"&lt;b&gt;Procedure：&lt;b&gt;\",input$procedure,\"   \", \"&lt;b&gt;IOL: &lt;b&gt;\", input$IOL_type,  \"&lt;br&gt;\", \n                \"&lt;br&gt;\",\n                \"&lt;b&gt;Doctor: &lt;b&gt;\", input$surger, \"   \",\"&lt;b&gt;Surgery Date: &lt;b&gt;\", format(input$Sob, \"%Y-%m-%d\"),\"&lt;br&gt;\",\n                \"&lt;br&gt;\",\n                \"&lt;b&gt;The patient is expected to have AL of &lt;b&gt;\", AL_15, \"&lt;b&gt;mm at the age of 15&lt;b&gt;\"))\n    \n  })\n  \n  #words_M_P,words_M_S,words_C_P, words_C_S, words_R\n  \n  output$table &lt;- renderDataTable({\n    table_reactive()\n  })\n  \n  word_val_ff &lt;- eventReactive(input$cal, {\n    today &lt;- Sys.Date()\n    dob &lt;- as.Date(input$dob)\n    surgery_date &lt;- as.Date(input$Sob)\n    aa &lt;- as.numeric(difftime(surgery_date, dob, units = \"days\")) / 365.25\n    values &lt;- calculateValues()\n    clus &lt;- values$clus\n    if(clus == \"A\") {\n      C_ph &lt;-  0\n    } else {\n      if(clus %in% c(\"C\",\"D\")){\n        C_ph &lt;- 3\n      }else{\n        C_ph &lt;- 1\n      }}\n    \n    if( aa &gt;15 ){\n      word_val()\n    }else{\n      if(C_ph == 3){\n        \n        word_val()\n        \n      }else{\n        \n        word_val_15()\n        \n      }\n    }\n    \n  })\n  output$words &lt;- renderUI({\n    word_val_ff()\n  })\n  \n  output$conditional_layout &lt;- renderUI({\n    values &lt;- calculateValues()\n    aa &lt;- values$aa\n    clus &lt;- values$clus\n    \n    if (aa &gt; 15 || clus %in% c(\"C\", \"D\")) {\n      div(\n        style = \"width: 100%; max-width: 1300px; margin: 0 auto;\", # 外层容器最大1300px\n        card(\n          style = \"width: 100%; max-width: 1300px; margin: 0 auto;\", # card充满容器\n          fluidRow(\n            div(\n              style = \"width: 600px; margin: 0 auto;\", # 固定内容宽度600px\n              uiOutput(\"words\")\n            )\n          ),\n          fluidRow(\n            div(\n              style = \"width: 600px; margin: 0 auto;\", # 固定内容宽度600px\n              DTOutput(\"table\")\n            )\n          )\n        )\n      )\n    } else {\n      div(\n        style = \"width: 100%; max-width: 1300px; margin: 0 auto; margin-top: 20px;\",\n        card(\n          fluidRow(\n            div(\n              style = \"width: 600px; margin: 0 auto;\",\n              uiOutput(\"words\")\n            )\n          ),\n          fluidRow(\n            column(\n              width = 6,\n              div(\n                style = \"width: 550px;\", # 表格区域固定宽度\n                DTOutput(\"table\")\n              )\n            ),\n            column(\n              width = 6,\n              tags$img(\n                src = \"sup1.png\",\n                style = \"width: 600px; \" # 图片固定宽度\n              )\n            )\n          )\n        )\n      )\n    }\n  })\n  output$words_cluster &lt;- renderUI({\n    clus &lt;- calculateValues()$clus\n    description &lt;- switch(clus,\n                          \"A\" = \"&lt;div style='text-align:justify;text-justify:inter-ideograph;margin:0 auto;max-width:90%'&gt;&lt;strong&gt;Cluster A:&lt;/strong&gt; Pediatric patients with nearly normal ocular features. These patients are typically younger and exhibit shorter axial lengths.&lt;/div&gt;\",\n                          \"B\" = \"&lt;div style='text-align:justify;text-justify:inter-ideograph;margin:0 auto;max-width:90%'&gt;&lt;strong&gt;Cluster B:&lt;/strong&gt; Pediatric patients characterized by longer axial lengths and flatter corneas.&lt;/div&gt;\",\n                          \"C\" = \"&lt;div style='text-align:justify;text-justify:inter-ideograph;margin:0 auto;max-width:90%'&gt;&lt;strong&gt;Cluster C:&lt;/strong&gt; Adolescents and adults with moderate axial lengths.&lt;/div&gt;\",\n                          \"D\" = \"&lt;div style='text-align:justify;text-justify:inter-ideograph;margin:0 auto;max-width:90%'&gt;&lt;strong&gt;Cluster D:&lt;/strong&gt; Individuals with significantly longer axial lengths.&lt;/div&gt;\",\n                          \"&lt;div style='text-align:justify;text-justify:inter-ideograph;margin:0 auto;max-width:90%'&gt;No cluster information available.&lt;/div&gt;\"\n    )\n    HTML(description)\n  })\n  \n  # PCO_sur 输出逻辑\n  output$PCO_sur &lt;- renderImage({\n    list(\n      src = \"sup1.png\",  \n      contentType = \"image/png\",   \n      width = \"100%\",           \n      height = \"auto\",                        \n      alt = \"PCO Survival Plot\"    \n    )\n  }, deleteFile = FALSE)  \n  \n}\n\napp &lt;- shinyApp(ui = ui, server = server)\napp$staticPaths &lt;- list(\n  `/` = httpuv::staticPath(\n    file.path(getwd(), \"www\"), indexhtml = FALSE, fallthrough = TRUE\n  )\n)\napp"
  }
]